// Seite zur Konfiguration der Gewichtsscheiben des Benutzers
@page "/create-plates"
@attribute [Authorize(Roles = "user")]

@using MCPowerlifting.Models.Entities
@using MCPowerlifting.Models.ViewModels
@rendermode InteractiveServer
@inject UserService UserService
@inject AppDbContext appDbContext
@inject NavigationManager navigationManager

// Hauptkarte für die Plattenauswahl
<div class="card m-4">
    <div class="card m-4" style="max-width:50vW;">
        <div class="card-header d-flex justify-content-center">
            <h2>What kind of plates do you own?</h2>
        </div>
        
        <!-- Checkbox-Gruppe zur Auswahl der verfügbaren Plattengewichte -->
        <div class="card-body d-flex justify-content-center">
            <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                @foreach (var checkPair in Checks)
                {
                    <input type="checkbox" @bind-value="@Checks[checkPair.Key]" class="btn-check" id="@("btn" + checkPair.Key.Substring(5))" autocomplete="off" style="min-width:5rem;">
                    <label class="btn btn-outline-primary" for="@("btn" + checkPair.Key.Substring(5))">@checkPair.Key.Substring(5) Kg</label>
                }
            </div>
        </div>
        
        <!-- Dynamische Anzeige von Eingabefeldern für die Anzahl der ausgewählten Platten -->
        <div class="card-body d-flex">
            @foreach (var checkPair in Checks)
            {
                if(checkPair.Value == true)
                {
                    <div style="max-width:10rem; margin-right: 10px;">
                        <label>@checkPair.Key.Substring(5)</label>
                        <input type="number" class="form-control" placeholder="0" aria-label="0" @bind-value="@PlateCounts[checkPair.Key]" />
                        <span class="input-group-text" id="@("span_" + checkPair.Key)">stk</span>
                    </div>
                }
            }
        </div>
    </div>
    
    <!-- Button zum Öffnen des Bestätigungs-Modals -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#PlateValidationModal">
        Save Plates
    </button>
    
    <!-- Bestätigungs-Modal mit Zusammenfassung der ausgewählten Platten -->
    <div class="modal fade" id="PlateValidationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Plate Validation</h1>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group-flush">
                        @foreach(var p in PlateCounts)
                        {
                            if (p.Value > 0)
                            {
                                <li class="list-group-item">
                                    @p.Key.Substring(5) Kg: @p.Value stk
                                </li>
                            };
                        }
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="CreatingPlateSave" data-dismiss="modal">Save Plates</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // ViewModel für die Kommunikation mit dem Server
    [SupplyParameterFromForm]
    public PlateViewModel Model { get; set; } = new PlateViewModel();

    // Fehlermeldung bei Validierungsproblemen
    private string? errorMessage;

    // Dictionary zur Verwaltung des Auswahlzustands jeder Plattenart
    // Key: "Check" + Gewicht, Value: Ist ausgewählt (true/false)
    public Dictionary<string, bool> Checks { get; set; } = new Dictionary<string, bool>
    {
        {"Check0,25", false},
        {"Check0,50", false},
        {"Check0,75", false},
        {"Check1,25", false},
        {"Check2,50", false},
        {"Check5,00", false},
        {"Check10,00", false},
        {"Check15,00", false},
        {"Check20,00", false},
        {"Check25,00", false}
    };

    // Dictionary zur Speicherung der Anzahl jeder ausgewählten Plattenart
    // Key: "Check" + Gewicht, Value: Anzahl der Platten
    public Dictionary<string, int> PlateCounts { get; set; } = new Dictionary<string, int>
    {
        {"Check0,25", 0},
        {"Check0,50", 0},
        {"Check0,75", 0},
        {"Check1,25", 0},
        {"Check2,50", 0},
        {"Check5,00", 0},
        {"Check10,00", 0},
        {"Check15,00", 0},
        {"Check20,00", 0},
        {"Check25,00", 0}
    };

    // Speichert die ausgewählten Platten in der Datenbank
    private async Task CreatingPlateSave()
    {
        // Benutzer-ID abrufen
        var userId = UserService.GetCurrentUserId();

        // Überprüfen, ob bereits eine Equipment-Konfiguration existiert (Langhantel)
        Equipment? equipment = appDbContext.Equipments.FirstOrDefault(e => e.UserId == userId);

        // Wenn keine Langhantel konfiguriert ist, zurück zur Programmkonfiguration
        if(equipment == null)
        {
            errorMessage = "Please enter a Barweight first.";
            navigationManager.NavigateTo("/create-program");
        }

        // Setze die Equipment-ID im Modell
        Model.EquipmentId = equipment.EquipmentId;

        // Erstelle für jede ausgewählte Plattenart einen Datenbankeintrag
        foreach (var p in PlateCounts)
        {
            if (p.Value > 0)
            {
                // Plattenobjekt für Datenbank erstellen
                Plate plate = new Plate
                    {
                        EquipmentId = Model.EquipmentId,
                        PlateWeight = Convert.ToDouble(p.Key.Substring(5)),  // Extrahiere Gewicht aus dem Key
                        PlateCount = p.Value  // Anzahl der Platten
                    };
                appDbContext.Plates.Add(plate);
            }
        }
        
        // Speichern der Änderungen in der Datenbank
        try
        {
            await appDbContext.SaveChangesAsync();
        }
        catch(Exception ex)
        {
            // Fehlerbehandlung sollte hier implementiert werden
            return;
        }

        // Weiterleitung zur Eingabe der Anfangsgewichte
        navigationManager.NavigateTo("/starting-weights");
    }
}